name: Notebook CI with WRDS Data

on:
  push:
    branches: [main, feature/wrds-data-integration]
  pull_request:
    branches: [main]

jobs:
  execute-notebook:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Install dependencies
      run: uv sync --extra jupyter

    - name: Download WRDS data from release
      run: uv run python scripts/download_release_data.py

    - name: Execute notebook with WRDS data
      env:
        WRDS_DATA_KEY: ${{ secrets.WRDS_DATA_KEY }}
      run: |
        uv run jupyter nbconvert \
          --to notebook \
          --execute \
          --inplace \
          notebooks/simulate_portfolio.ipynb

    - name: Upload executed notebook
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: executed-notebook
        path: notebooks/simulate_portfolio.ipynb
